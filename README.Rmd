---
output: rmarkdown::github_document
always_allow_html: yes
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

# STAT 585 Lab 4 - Group 5
 
**Katherine Goode, Gina Nichols, Xiyuan Sun, Ying Zheng**  
**04/21/2019**

This document contains an overview of our work for lab 4. Our GitHub repository for this lab can be found [here](https://github.com/xiyuansun/stat585Lab4).

```{r message = FALSE}
# Libraries used
library(tidyverse)
library(readr)
library(dplyr)
library(stringr)
```

## Iowa Liquor Sales Data

#### Demonstration of Accessing the Data from the API

```{r api}

#get_liquor function
get_liquor <- function(url){
  initialjson <- jsonlite::read_json(url)
  tot_length <- length(initialjson)
  liquor_data <- list()
  for(i in 1:tot_length){
    test_json_file <- initialjson[[i]]
    
    invoice <- test_json_file$invoice_line_no
    date <- gsub("[A-z].*$","",test_json_file$date)
    store_number <- test_json_file$store
    store_name <- test_json_file$name
    address <- test_json_file$address
    city <- test_json_file$city
    zipcode <- test_json_file$zipcode
    store_location <-paste0(address, " \n ", city, zipcode," \n (",
                            as.numeric(unlist(test_json_file$store_location)[-1])[1],", ", 
                            as.numeric(unlist(test_json_file$store_location)[-1])[2], ")")
    county_number <- test_json_file$county_number
    county <- test_json_file$county
    category <- test_json_file$category
    category_name <- test_json_file$category_name
    vendor_number <- test_json_file$vendor_no
    vendor_name <- test_json_file$vendor_name
    item_number <- test_json_file$itemno
    item_descp <- test_json_file$im_desc
    pack <- test_json_file$pack
    bottle_vol <- test_json_file$bottle_volume_ml 
    state_bottle_cost <- test_json_file$state_bottle_cost
    state_bottle_retail <- test_json_file$state_bottle_retail
    sale_bottles <- test_json_file$sale_bottles
    sale_dollars <- test_json_file$sale_dollars
    sale_liters <- test_json_file$sale_liters
    sale_gallons <- test_json_file$sale_gallons
    
    result_df <- as.data.frame(cbind(invoice, date, store_number, store_name, 
                       address, city, zipcode, store_location,
                       county_number, county, category, category_name,
                       vendor_number, vendor_name, item_number, item_descp,pack,
                       bottle_vol, state_bottle_cost, state_bottle_retail, sale_bottles,sale_dollars, 
                       sale_liters, sale_gallons))
    
    liquor_data[[i]]<- result_df
    
  }
  
  
  return(liquor_data)
  
}

# access the data from the API

liquor_list <- get_liquor(url="https://data.iowa.gov/resource/m3tr-qhgy.json")

# convert lists to a data frame


#skip those rows
liquor_df <- c()
for(i in 1:1000){
  liquor_df <- rbind(liquor_df, liquor_list[[i]])
}

# Glimpse the data
glimpse(liquor_df)


```

#### Data Cleaning

For the Shiny app, we will use the full Story County liquor sales dataset provided by Dr. Hofmann. This data is read in below.

```{r}
# Read in data
story_liquor_raw <- read_csv("data/Iowa_Liquor_Sales-Story.csv", col_types = cols())
```

We cleaned up the data before using it in the Shiny app. This involved renaming the variables, adjusting the variable types, and dealing with typos. This work is all included in the following section of code.

```{r dat clean}
# Clean data
story_liquor_cleaned <- story_liquor_raw %>%
  
  # Rename cols
  rename_all(funs(
  str_replace_all(., "[\\(\\)_\\/ ]", "") %>%
  tolower())) %>%
  
  # Adjust date variable
  mutate(date = lubridate::mdy(date)) %>%

  # Send character variables to lower
  mutate_if(.predicate = is.character,
            .funs = tolower) %>%
  
  # Create factor variables where necessary
  mutate_at(.vars = c("storenumber", 
                      "storename", 
                      "address", 
                      "city",
                      "zipcode", 
                      "storelocation", 
                      "countynumber",
                      "county",
                      "category", 
                      "categoryname", 
                      "vendornumber", 
                      "vendorname", 
                      "itemnumber", 
                      "pack"),
            .funs = factor) %>%
  
  # Clean up factor variables
  mutate(address = str_replace(address, ",", ""),
         address = str_replace(address, "issac", "isaac"),
         address = str_replace(address, "4518 mortenson rd ste 109", "4518 mortonsen street suite #109"),
         address = str_replace(address, "lincolnway", "lincoln way"),
         storename = str_replace(storename, "a j's", "aj's"),
         storename = str_replace(storename, "casey's general store # 2560/ ames", 
                                 "casey's general store # 2560"),
         storename = str_replace(storename, "casey's general store # 2560", 
                                 "casey's general store #2560 / ames"), 
         storelocation = str_split(storelocation, "\n", simplify = TRUE)[,3],
         latitude = str_split(storelocation, ", ", simplify = TRUE)[,1] %>% 
           str_replace("\\(", "") %>%
           as.numeric(),
         longitude = str_split(storelocation, ", ", simplify = TRUE)[,2] %>%
           str_replace("[\\)]", "") %>%
           as.numeric(),
         categoryname = str_replace(categoryname, "american cordials & liqueurs", 
                                    "american cordials & liqueur"),
         categoryname = str_replace(categoryname, "american distilled spirits specialty", 
                                    "american distilled spirit specialty"),
         categoryname = str_replace(categoryname, "american vodkas", "american vodka"),
         categoryname = str_replace(categoryname, "cocktails /rtd", "cocktails / rtd"),
         categoryname = str_replace(categoryname, "flavored gins", "flavored gin"),
         categoryname = str_replace(categoryname, "imported distilled spirits specialty", 
                                    "imported distilled spirit specialty"),
         categoryname = str_replace(categoryname, "imported vodkas", "imported vodka"),
         vendorname = str_replace_all(vendorname, "[,\\.\\/-]", "")) %>%
  group_by(vendornumber) %>%
  mutate(vendorname = vendorname[1]) %>%
  ungroup() %>%
  mutate(vendorname = factor(vendorname)) %>%
  
  # Get rid of weird extremes
  filter(saledollars > 0,
  volumesoldliters > 0,
  volumesoldgallons > 0,
  volumesoldliters < 250) %>%
  
  # Assign new simple categories
  mutate(
    catsimp = factor(case_when(
      grepl("amaretto", categoryname) ~ "amaretto",
      grepl("brand", categoryname) ~ "brandy",
      grepl("creme", categoryname) ~ "creme",
      grepl("cocktail|sec", categoryname) ~ "general_mixer",
      grepl("spirit", categoryname) ~ "general_spirit",
      grepl("gin", categoryname) ~ "gin",
      grepl("liqueur", categoryname) ~ "liqueur",
      grepl("schnap", categoryname) ~ "schnapps",
      grepl("rum", categoryname) ~ "rum",
      grepl("special", categoryname) ~ "specialty",
      grepl("tequ|mez", categoryname) ~ "tequila",
      grepl("vodka", categoryname) ~ "vodka",
      grepl("whisk|bourb|scotch|rye", categoryname) ~ "whisky"
      ))
    ) %>%
  
  # Select the final order of the variables
  select(invoiceitemnumber:storelocation, 
         latitude, 
         longitude, 
         countynumber:categoryname, 
         catsimp, 
         vendornumber:volumesoldgallons)
```

A glimpse of the cleaned data is shown below.

```{r}
# Glimpse the data
glimpse(story_liquor_cleaned)
```

## Shiny App Visualizations
